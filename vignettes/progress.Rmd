---
title: "Progress bars in cli"
author: "Gábor Csárdi"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    toc_depth: 2
editor_options:
  markdown:
    wrap: sentence
---

```{r, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  cache = TRUE
)
# Turn on ANSI colors
options(cli.num_colors = 256L)
asciicast::init_knitr_engine(
  startup = quote({
    library(cli)
    set.seed(1) }),
  echo = TRUE,
  echo_input = FALSE)
```

```{r, setup}
library(cli)
```

# Status bars

## Simplified API

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
f <- function() {
  cli_status("Task one is running...")
  Sys.sleep(2)

  cli_status("Task two is running...")
  Sys.sleep(2)

  step <- 1L
  cli_status("Task three is underway: step {step}")
  for (step in 1:5) {
    Sys.sleep(0.5)
    cli_status_update()
  }
}
f()
```

## Alternative API

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 3)}
f <- function(n = 10) {
  cli_alert_info("About to start downloads of {n} file{?s}")
  i <- 0
  sb <- cli_process_start("Got {i}/{n} {qty(i)}file{?s}.")
  for (i in seq_len(n)) {
    Sys.sleep(0.5)
    if (i == 5) cli_alert_info("Already half way!")
    cli_process_update()
  }
}
f()
```

##  Tight loops

40-60ns per iterations, without printing.

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
f <- function() {
  i <- 0L
  cli_status("{.alert-info Read {i} files}")
  for (i in 1:10000) {
    Sys.sleep(5/10000)
    if (should_tick) cli_status_update()
  }
}
f()
```

# Progress bars

## Explicit start, update and termination

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
cli_progress_bar(total = 100)
for (i in 1:100) {
  Sys.sleep(5/100)
  cli_progress_update()
}
cli_progress_done()
```

## Tight loops

40-60ns per iterations, without printing.

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
f <- function() {
  cli_progress_bar(total = 10000)
  for (i in 1:10000) {
    Sys.sleep(5/10000)
    if (should_tick) cli_progress_update(set = i)
  }
}
f()
```

## Unknown total

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
cli_progress_bar()
for (i in 1:100) {
  Sys.sleep(5/100)
  cli_progress_update()
}
cli_progress_done()
```

## Downloads

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
cli_progress_bar(type = "download")
for (i in 1:100) {
  Sys.sleep(5/100)
  cli_progress_update(1024)
}
cli_progress_done()
```

## Custom format

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
f <- function() {
  cli_progress_bar(
    total = 30000,
    format = "Step {step} | {pb_bar} {pb_percent}"
  )
  step <- 1
  for (i in 1:10000) {
    Sys.sleep(3/10000)
    if (should_tick) cli_progress_update(set = i)
  }
  step <- 2
  for (i in 10001:20000) {
    Sys.sleep(2/10000)
    if (should_tick) cli_progress_update(set = i)
  }
}
f()
```

## Very custom format

A silly example, but you can use custom functions on progress
bar tokens:

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
cli_progress_bar(
  total = 26,
  format = "This is step {.emph {letters[pb_current]}}."
)
for (i in 1:26) {
  Sys.sleep(3/26)
  cli_progress_update()
}
```

## While loops with `ticking()`

```{asciicast, R.options = list(asciicast_at = NULL, asciicast_end_wait = 3, asciicast_rows = 1)}
i <- 0
while (ticking(i < 100)) {
  Sys.sleep(3/100)
  i <- i + 1
}
```

## Mapping with `tick_along()`

Not implemented yet.
Needs R 3.5.0.
Should to be very fast, 2-3ns overhead per iteration.

```{r, eval = FALSE}
lapply(
  tick_along(filenames),
  function(i) readr::read_csv(filenames[i])
)
```
