---
title: "Progress bars in cli"
author: "Gábor Csárdi"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    toc_depth: 2
editor_options:
  markdown:
    wrap: sentence
---

```{r, include = FALSE, cache = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  cache = TRUE
)
# Turn on ANSI colors
options(
  cli.num_colors = 256L,
  cli_speed = 1
)
asciicast::init_knitr_engine(
  startup = bquote({
    Sys.setenv(CLI_SPEED_TIME = .(getOption("cli_speed")))
    library(cli)
    .GlobalEnv$Sys.sleep <- function(time) {
      base::Sys.sleep(time / .(getOption("cli_speed")))
    }
    set.seed(1)
  }),
  echo = TRUE,
  echo_input = FALSE,
  options = list(
    asciicast_at = NULL,
    asciicast_end_wait = 3 / getOption("cli_speed"),
    asciicast_speed = 1 / getOption("cli_speed"),
    asciicast_cpp11_linkingto = "[[cpp11::linking_to(\"cli\")]]"
  )
)
getOption("asciicast_speed")
```

```{r, setup}
library(cli)
```

# Status bars

```{asciicast, include = FALSE}
# To test that we shimmed Sys.sleep and the time is speeded up
Sys.sleep
cli:::clienv$speed_time
cli:::clienv$tick_time
```

## Simplified API

```{asciicast}
f <- function() {
  cli_status("Task one is running...")
  Sys.sleep(2)

  cli_status("Task two is running...")
  Sys.sleep(2)

  step <- 1L
  cli_status("Task three is underway: step {step}")
  for (step in 1:5) {
    Sys.sleep(0.5)
    cli_status_update()
  }
}
f()
```

## Alternative API

```{asciicast}
f <- function(n = 10) {
  cli_alert_info("About to start downloads of {n} file{?s}")
  i <- 0
  sb <- cli_process_start("Got {i}/{n} {qty(i)}file{?s}.")
  for (i in seq_len(n)) {
    Sys.sleep(0.5)
    if (i == 5) cli_alert_info("Already half way!")
    cli_process_update()
  }
}
f()
```

##  Tight loops

40-60ns per iterations, without printing.

```{asciicast}
f <- function() {
  i <- 0L
  cli_status("{.alert-info Read {i} files}")
  for (i in 1:10000) {
    Sys.sleep(5/10000)
    if (should_tick) cli_status_update()
  }
}
f()
```

# Progress bars in R

## Explicit start, update and termination

```{asciicast}
cli_progress_bar(total = 100)
for (i in 1:100) {
  Sys.sleep(5/100)
  cli_progress_update()
}
cli_progress_done()
```

## Tight loops

40-60ns per iterations, without printing.

```{asciicast}
f <- function() {
  cli_progress_bar(total = 10000)
  for (i in 1:10000) {
    Sys.sleep(5/10000)
    if (should_tick) cli_progress_update(set = i)
  }
}
f()
```

## Unknown total

```{asciicast}
cli_progress_bar()
for (i in 1:100) {
  Sys.sleep(5/100)
  cli_progress_update()
}
cli_progress_done()
```

## Downloads

```{asciicast}
cli_progress_bar(type = "download")
for (i in 1:100) {
  Sys.sleep(5/100)
  cli_progress_update(1024)
}
cli_progress_done()
```

## Custom format

```{asciicast}
f <- function() {
  cli_progress_bar(
    total = 20000,
    format = "Step {step} | {pb_bar} {pb_percent}"
  )
  step <- 1
  for (i in 1:10000) {
    Sys.sleep(2/10000)
    if (should_tick) cli_progress_update(set = i)
  }
  step <- 2
  for (i in 10001:20000) {
    Sys.sleep(2/10000)
    if (should_tick) cli_progress_update(set = i)
  }
}
f()
```

## Very custom format

A silly example, but you can use custom functions on progress
bar tokens:

```{asciicast}
cli_progress_bar(
  total = 26,
  format = "This is step {.emph {letters[pb_current]}}."
)
for (i in 1:26) {
  Sys.sleep(3/26)
  cli_progress_update()
}
```

## While loops with `ticking()`

```{asciicast}
i <- 0
while (ticking(i < 100)) {
  Sys.sleep(3/100)
  i <- i + 1
}
```

## Mapping with `tick_along()`

Needs R 3.5.0.

```{asciicast}
out <- lapply(
  tick_along(letters),
  function(i) Sys.sleep(1)
)
```

# Progress bars in C

```{asciicastcpp11}
#include <cli/progress.h>
SEXP progress_test1() {
  int i;
  SEXP bar = PROTECT(cli_progress_bar(1000));
  for (i = 0; i < 1000; i++) {
    cli_progress_sleep(0, 4 * 1000 * 1000);
    if (SHOULD_TICK) cli_progress_set(bar, i);
  }
  cli_progress_done(bar);
  UNPROTECT(1);
  return Rf_ScalarInteger(i);
}
```

```{asciicast, dependson = -1}
progress_test1()
```
